<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cocktail Compatibility Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            /* Modern minimalist with tropical accents */
            --primary: #0a7ea4;
            --primary-dark: #076a8a;
            --primary-light: #e0f4f9;
            --secondary: #ff6b6b;
            --secondary-dark: #e85555;
            --secondary-light: #ffe5e5;

            /* Tropical accent colors */
            --coral: #ff7b54;
            --teal: #14b8a6;
            --sunset: #ffa94d;
            --palm: #10b981;

            /* Category colors */
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0a7ea4;

            /* Modern backgrounds */
            --bg-primary: #ffffff;
            --bg-secondary: #fafaf9;
            --bg-tertiary: #f5f5f4;
            --bg-hover: #f0f0ef;
            --bg-accent: linear-gradient(135deg, #fff7ed 0%, #fef3f2 100%);

            /* Text colors */
            --text-primary: #1c1917;
            --text-secondary: #78716c;
            --text-tertiary: #d6d3d1;

            /* Borders and dividers */
            --border: #d6d3d1;
            --border-light: #e7e5e4;

            /* Enhanced shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 20px 25px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 25px 50px rgba(0, 0, 0, 0.15);

            --sidebar-width: 260px;
            --radius: 16px;
            --radius-sm: 10px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* App Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--bg-primary) 0%, #fafaf9 100%);
            border-right: 1px solid var(--border-light);
            padding: 32px 0;
            position: fixed;
            height: 100vh;
            left: 0;
            top: 0;
            overflow-y: auto;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.03);
        }

        .sidebar-brand {
            padding: 0 24px 24px;
            border-bottom: 1px solid var(--border-light);
            margin-bottom: 24px;
        }

        .sidebar-brand h1 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sidebar-brand .tagline {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav-item {
            padding: 0 16px;
            margin-bottom: 4px;
        }

        .sidebar-nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.9375rem;
            font-weight: 500;
            transition: all 0.15s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .sidebar-nav-link:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .sidebar-nav-link.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--teal) 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(10, 126, 164, 0.25);
        }

        .sidebar-nav-link .icon {
            font-size: 1.25rem;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 32px;
            max-width: calc(100vw - var(--sidebar-width));
        }

        .page-header {
            margin-bottom: 32px;
        }

        .page-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
        }
        /* Cards & Sections */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius);
            padding: 24px;
            border: 1px solid var(--border-light);
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--coral) 0%, var(--sunset) 50%, var(--teal) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .card:hover::before {
            opacity: 1;
        }
        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .upload-section {
            background: var(--bg-primary);
            padding: 24px;
            border-radius: var(--radius);
            border: 1px solid var(--border-light);
            margin-bottom: 24px;
            box-shadow: var(--shadow-sm);
        }

        .file-input-group {
            margin-bottom: 20px;
        }

        .file-input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--border);
            border-radius: var(--radius-sm);
            background: var(--bg-secondary);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        input[type="file"]:hover {
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        /* Buttons */
        button {
            background: linear-gradient(135deg, var(--primary) 0%, var(--teal) 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 0.9375rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            box-shadow: 0 2px 8px rgba(10, 126, 164, 0.2);
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(10, 126, 164, 0.3);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(10, 126, 164, 0.2);
        }

        button:disabled {
            background: var(--text-tertiary);
            cursor: not-allowed;
            opacity: 0.5;
            box-shadow: none;
        }

        .btn-primary {
            background: var(--primary);
            width: 100%;
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--text-secondary) 0%, #57534e 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        .btn-danger:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.875rem;
        }
        .error-message {
            background: #fff5f5;
            color: var(--danger);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            border-left: 3px solid var(--danger);
            font-size: 0.9375rem;
        }
        .info-message {
            background: var(--primary-light);
            color: var(--primary-dark);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
            border-left: 3px solid var(--primary);
            font-size: 0.9375rem;
        }
        #results {
            margin-top: 30px;
        }
        .category {
            margin-bottom: 32px;
        }
        .category-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 16px;
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            border-left: 4px solid;
        }
        .perfect {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            color: var(--palm);
            border-left-color: var(--palm);
        }
        .very-good {
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            color: var(--sunset);
            border-left-color: var(--sunset);
        }
        .good {
            background: linear-gradient(135deg, #e0f4f9 0%, #cfe9f3 100%);
            color: var(--primary-dark);
            border-left-color: var(--teal);
        }
        .recipe-item {
            background: var(--bg-primary);
            padding: 18px;
            margin-bottom: 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            border-left: 4px solid transparent;
            background-image: linear-gradient(var(--bg-primary), var(--bg-primary)),
                            linear-gradient(135deg, var(--coral) 0%, var(--sunset) 100%);
            background-origin: border-box;
            background-clip: padding-box, border-box;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .recipe-item:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--shadow-lg);
            border-color: transparent;
        }
        .recipe-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }
        .recipe-details {
            color: var(--text-secondary);
            margin-top: 6px;
            font-size: 0.875rem;
        }
        .missing {
            color: var(--danger);
            font-style: italic;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border-light);
            padding: 28px;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--coral) 0%, var(--sunset) 50%, var(--teal) 100%);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .stat-number {
            font-size: 2.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--teal) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .loading {
            text-align: center;
            padding: 48px;
            font-size: 1rem;
            color: var(--text-secondary);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            overflow-y: auto;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: var(--bg-primary);
            border-radius: var(--radius);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.2s ease;
            box-shadow: var(--shadow-lg);
        }
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal-close {
            position: absolute;
            top: 24px;
            right: 24px;
            font-size: 1.75rem;
            cursor: pointer;
            color: var(--text-secondary);
            line-height: 1;
            transition: color 0.15s;
        }
        .modal-close:hover {
            color: var(--text-primary);
        }
        .modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 24px;
        }
        .modal-section {
            margin-bottom: 28px;
        }
        .modal-section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .modal-section-content {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: var(--radius-sm);
            line-height: 1.6;
            color: var(--text-primary);
        }
        .ingredient-list {
            list-style: none;
            padding: 0;
        }
        .ingredient-list li {
            padding: 10px;
            border-bottom: 1px solid var(--border-light);
        }
        .ingredient-list li:last-child {
            border-bottom: none;
        }
        .ingredient-list li.have {
            color: var(--success);
        }
        .ingredient-list li.have::before {
            content: "‚úì ";
            font-weight: 600;
        }
        .ingredient-list li.missing {
            color: var(--danger);
        }
        .ingredient-list li.missing::before {
            content: "‚úó ";
            font-weight: 600;
        }
        .compatibility-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .search-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            padding: 32px;
            border-radius: var(--radius);
            margin-bottom: 32px;
            display: none;
            box-shadow: var(--shadow-sm);
        }
        .search-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        .search-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        .search-controls {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }
        .search-controls select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            margin-bottom: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .search-btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.9375rem;
        }
        .search-btn:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-md);
        }
        .search-response {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 20px;
            border-radius: var(--radius-sm);
            margin-top: 20px;
            display: none;
            border: 1px solid var(--border-light);
        }
        .search-response.active {
            display: block;
        }
        .shopping-list-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            padding: 32px;
            border-radius: var(--radius);
            margin-bottom: 32px;
            display: none;
            box-shadow: var(--shadow-sm);
        }
        .shopping-list-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
        }
        .shopping-item {
            background: var(--bg-secondary);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .shopping-item-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        .shopping-item-impact {
            background: var(--success);
            color: white;
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .file-status {
            margin-top: 12px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        .file-status.success {
            color: var(--success);
        }
        .file-status.error {
            color: var(--danger);
        }
        .ai-search-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            padding: 32px;
            border-radius: var(--radius);
            margin-bottom: 32px;
            display: none;
            box-shadow: var(--shadow-sm);
        }
        .ai-search-section input[type="text"],
        .ai-search-section input[type="password"],
        .ai-search-section textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            margin-bottom: 12px;
            font-family: inherit;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .ai-search-section textarea {
            min-height: 100px;
            resize: vertical;
        }
        .ai-query-btn {
            padding: 12px 24px;
            background: var(--secondary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 0.9375rem;
            margin-right: 12px;
        }
        .ai-query-btn:hover:not(:disabled) {
            background: #4745c7;
            box-shadow: var(--shadow-md);
        }
        .ai-query-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .api-key-section {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
            font-size: 0.875rem;
            border: 1px solid var(--border-light);
        }
        .api-key-status {
            margin-top: 5px;
            font-size: 0.85em;
        }
        .collapse-btn {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            margin-left: 12px;
            transition: all 0.15s ease;
        }
        .collapse-btn:hover {
            background: var(--bg-hover);
        }
        .ai-context-info {
            background: linear-gradient(135deg, var(--primary-light) 0%, #f0f9ff 100%);
            padding: 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 24px;
            border-left: 4px solid var(--primary);
        }

        .ai-context-info ul {
            margin: 12px 0 0 20px;
            color: var(--text-primary);
        }

        .ai-context-info li {
            margin-bottom: 6px;
        }

        .ai-query-section {
            margin-bottom: 24px;
        }

        .ai-query-section textarea {
            min-height: 140px;
            font-size: 0.9375rem;
            line-height: 1.6;
        }

        .ai-button-row {
            display: flex;
            gap: 12px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .ai-examples {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: var(--radius-sm);
            margin-top: 12px;
            font-size: 0.875rem;
            border: 1px solid var(--border-light);
        }

        .ai-examples-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .ai-example-card {
            background: var(--bg-primary);
            padding: 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
        }

        .ai-example-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .ai-example-card strong {
            display: block;
            color: var(--primary);
            margin-bottom: 6px;
            font-size: 0.875rem;
        }

        .ai-example-card p {
            color: var(--text-secondary);
            font-size: 0.8125rem;
            font-style: italic;
            margin: 0;
        }

        .ai-response-area {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
            border-radius: var(--radius-sm);
            margin-top: 20px;
            display: none;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
        }

        .ai-response-area.active {
            display: block;
        }

        .ai-response-area h3 {
            color: var(--primary);
            margin-bottom: 12px;
        }

        .ai-response-area pre {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: var(--radius-sm);
            overflow-x: auto;
        }
        .favorite-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px 10px;
            transition: transform 0.2s;
            width: auto;
        }
        .favorite-btn:hover {
            transform: scale(1.2);
        }
        .favorite-btn.active {
            color: #ff6b6b;
        }
        .made-this-section {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-top: 16px;
            border: 1px solid var(--border-light);
        }
        .rating-stars {
            font-size: 1.5rem;
            cursor: pointer;
            user-select: none;
        }
        .rating-stars span {
            color: var(--border);
            transition: color 0.15s;
        }
        .rating-stars span.filled {
            color: var(--warning);
        }
        .rating-stars span:hover,
        .rating-stars span:hover ~ span {
            color: var(--warning);
        }
        .notes-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-top: 12px;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            font-size: 0.9375rem;
        }
        .inventory-manager {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            padding: 32px;
            border-radius: var(--radius);
            margin-bottom: 32px;
            display: none;
            box-shadow: var(--shadow-sm);
        }
        .inventory-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .inventory-item {
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .inventory-item-name {
            flex: 1;
            font-weight: 600;
            color: var(--text-primary);
        }
        .inventory-item-rich {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .inventory-item-details {
            flex: 1;
        }
        .inventory-item-secondary {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        .inventory-item-notes {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 6px;
            line-height: 1.4;
        }
        .inventory-tasting-profile {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: 8px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            line-height: 1.5;
            border: 1px solid var(--border-light);
        }
        .inventory-tasting-profile div {
            margin-bottom: 4px;
        }
        .inventory-tasting-profile strong {
            color: var(--text-primary);
        }
        .inventory-remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.875rem;
            width: auto;
            flex-shrink: 0;
            margin-left: 12px;
            transition: all 0.15s ease;
        }
        .inventory-remove-btn:hover {
            background: #e02d22;
            box-shadow: var(--shadow-sm);
        }
        .inventory-add-section {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-top: 24px;
            border: 1px solid var(--border-light);
        }
        .inventory-add-input {
            width: calc(100% - 120px);
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            margin-right: 12px;
            font-size: 0.9375rem;
        }
        .inventory-add-btn {
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            width: auto;
            transition: all 0.15s ease;
        }
        .favorites-section {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            padding: 32px;
            border-radius: var(--radius);
            margin-bottom: 32px;
            display: none;
            box-shadow: var(--shadow-sm);
        }
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        .action-btn {
            padding: 10px 20px;
            border: 2px solid var(--primary);
            background: var(--bg-primary);
            color: var(--primary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.15s ease;
            width: auto;
            font-size: 0.9375rem;
        }
        .action-btn:hover {
            background: var(--primary-light);
        }
        .action-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }
        .nav-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .nav-tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        /* Tab Content Sections */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Clean up section margins when in tabs */
        .tab-content .favorites-section,
        .tab-content .inventory-manager,
        .tab-content .ai-search-section,
        .tab-content .search-section {
            display: block;
            margin-bottom: 0;
        }

        /* Search & Filter Controls */
        .filter-controls {
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-md);
        }

        .quick-actions-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 10px 18px;
            background: linear-gradient(135deg, var(--coral) 0%, var(--sunset) 100%);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(255, 123, 84, 0.2);
        }

        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 123, 84, 0.3);
        }

        .quick-action-btn.active {
            background: linear-gradient(135deg, var(--palm) 0%, var(--teal) 100%);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .quick-action-btn-secondary {
            padding: 10px 18px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .quick-action-btn-secondary:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .sort-bar {
            margin-bottom: 16px;
        }

        .sort-select {
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-sm);
            font-size: 0.9375rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 200px;
        }

        .sort-select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .active-filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            margin-bottom: 16px;
        }

        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--primary-light);
            color: var(--primary-dark);
            border-radius: 20px;
            font-size: 0.8125rem;
            font-weight: 600;
        }

        .filter-tag-remove {
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.15s;
        }

        .filter-tag-remove:hover {
            transform: scale(1.2);
        }

        .results-count {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Recently Viewed */
        .recently-viewed-section {
            margin-bottom: 32px;
        }

        .section-subtitle {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
        }

        .recently-viewed-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .recently-viewed-item {
            background: var(--bg-primary);
            padding: 14px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-light);
            cursor: pointer;
            transition: all 0.25s ease;
            box-shadow: var(--shadow-sm);
        }

        .recently-viewed-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--coral);
        }

        .recently-viewed-name {
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .recently-viewed-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 240px;
            }

            .sidebar {
                width: var(--sidebar-width);
            }

            .main-content {
                margin-left: var(--sidebar-width);
                padding: 20px;
            }

            .page-title {
                font-size: 1.5rem;
            }

            .stats {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .inventory-list {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 640px) {
            :root {
                --sidebar-width: 0;
            }

            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                padding: 0;
            }

            .sidebar-nav-item {
                padding: 0;
            }

            .sidebar-nav-link {
                white-space: nowrap;
                padding: 12px 16px;
            }

            .main-content {
                margin-left: 0;
                padding: 16px;
            }

            .card,
            .upload-section,
            .search-section,
            .shopping-list-section,
            .ai-search-section,
            .inventory-manager,
            .favorites-section {
                padding: 20px;
            }

            .modal-content {
                padding: 24px;
            }

            .inventory-add-input {
                width: 100%;
                margin-bottom: 12px;
            }

            .inventory-add-btn {
                width: 100%;
            }

            .sort-select {
                width: 100%;
                min-width: auto;
            }

            .quick-actions-bar {
                gap: 8px;
            }

            .quick-action-btn,
            .quick-action-btn-secondary {
                flex: 1;
                min-width: calc(50% - 4px);
                font-size: 0.8125rem;
                padding: 10px 12px;
            }

            .recently-viewed-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <h1>üçπ Bartender</h1>
                <p class="tagline">Your cocktail companion</p>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-nav-item">
                    <button class="sidebar-nav-link active" data-tab="home">
                        <span class="icon">üè†</span>
                        <span>Home</span>
                    </button>
                </div>
                <div class="sidebar-nav-item">
                    <button class="sidebar-nav-link" data-tab="mybar">
                        <span class="icon">üì¶</span>
                        <span>My Bar</span>
                    </button>
                </div>
                <div class="sidebar-nav-item">
                    <button class="sidebar-nav-link" data-tab="recipes">
                        <span class="icon">üìö</span>
                        <span>Recipes</span>
                    </button>
                </div>
                <div class="sidebar-nav-item">
                    <button class="sidebar-nav-link" data-tab="favorites">
                        <span class="icon">‚ù§Ô∏è</span>
                        <span>Favorites</span>
                    </button>
                </div>
                <div class="sidebar-nav-item">
                    <button class="sidebar-nav-link" data-tab="ai">
                        <span class="icon">ü§ñ</span>
                        <span>AI Assistant</span>
                    </button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page: Home/Upload -->
            <div id="tab-home" class="tab-content active">
                <div class="page-header">
                    <h2 class="page-title">Get Started</h2>
                    <p class="page-subtitle">Upload your bar stock and recipes to discover what cocktails you can make</p>
                </div>

                <div class="upload-section">
                    <div class="file-input-group">
                        <label>üì¶ Bar Stock CSV</label>
                        <input type="file" id="inventoryFile" accept=".csv">
                        <div id="inventoryStatus" class="file-status"></div>
                    </div>

                    <div class="file-input-group">
                        <label>üìö Recipe Collection CSV(s)</label>
                        <input type="file" id="recipeFile" accept=".csv" multiple>
                        <div id="recipeStatus" class="file-status"></div>
                    </div>

                    <button id="analyzeBtn" class="btn-primary" disabled>Analyze My Bar</button>
                </div>

                <!-- Backup/Restore Section -->
                <div class="card" style="margin-top: 24px;">
                    <h3 style="margin-bottom: 12px; font-size: 1.125rem; font-weight: 600;">üíæ Backup & Restore</h3>
                    <p style="color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 16px;">
                        Export your data to keep a backup, or import to restore on a new device.
                    </p>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button id="exportDataBtn" class="btn-secondary btn-sm">‚¨áÔ∏è Export Data</button>
                        <label for="importDataFile" class="btn-secondary btn-sm" style="margin: 0; display: inline-block;">
                            ‚¨ÜÔ∏è Import Data
                            <input type="file" id="importDataFile" accept=".json" style="display: none;">
                        </label>
                    </div>
                </div>

                <div id="shoppingList" class="shopping-list-section"></div>
            </div>

            <!-- Page: My Bar -->
            <div id="tab-mybar" class="tab-content">
                <div class="page-header">
                    <h2 class="page-title">My Bar</h2>
                    <p class="page-subtitle">Manage your bottle collection</p>
                </div>
                <div id="inventoryManager" class="inventory-manager"></div>
            </div>

            <!-- Page: Recipes -->
            <div id="tab-recipes" class="tab-content">
                <div class="page-header">
                    <h2 class="page-title">Recipes</h2>
                    <p class="page-subtitle">Browse and search your cocktail collection</p>
                </div>

                <div id="searchSection" class="search-section">
                <div class="search-title">üîç Find Drinks by Ingredient</div>
                <div class="search-subtitle">Select an ingredient from your bar to find matching cocktails</div>

                <div class="search-controls">
                    <select id="ingredientSelect">
                        <option value="">-- Select an ingredient --</option>
                    </select>
                    <button id="searchBtn" class="search-btn">Find Drinks</button>
                </div>

                <div id="searchResponse" class="search-response"></div>
            </div>

            <!-- Advanced Search & Filter Controls -->
            <div id="filterControls" class="filter-controls" style="display: none;">
                <!-- Quick Actions Bar -->
                <div class="quick-actions-bar">
                    <button id="randomCocktailBtn" class="quick-action-btn">
                        üé≤ Random Cocktail
                    </button>
                    <button id="perfectMatchesBtn" class="quick-action-btn">
                        ‚ú® Perfect Matches
                    </button>
                    <button id="almostThereBtn" class="quick-action-btn">
                        üéØ Missing 1 Ingredient
                    </button>
                    <button id="clearFiltersBtn" class="quick-action-btn-secondary">
                        ‚Ü∫ Clear Filters
                    </button>
                </div>

                <!-- Sort Options -->
                <div class="sort-bar">
                    <select id="sortSelect" class="sort-select">
                        <option value="compatibility">Sort by Compatibility</option>
                        <option value="name-asc">Sort A-Z</option>
                        <option value="name-desc">Sort Z-A</option>
                    </select>
                </div>

                <!-- Active Filters Display -->
                <div id="activeFilters" class="active-filters" style="display: none;"></div>

                <!-- Results Count -->
                <div id="resultsCount" class="results-count"></div>
            </div>

            <!-- Recently Viewed -->
            <div id="recentlyViewedSection" class="recently-viewed-section" style="display: none;">
                <h3 class="section-subtitle">üëÅÔ∏è Recently Viewed</h3>
                <div id="recentlyViewedList" class="recently-viewed-list"></div>
            </div>

            <div id="results"></div>
        </div>

            <!-- Page: Favorites -->
            <div id="tab-favorites" class="tab-content">
                <div class="page-header">
                    <h2 class="page-title">My Collection</h2>
                    <p class="page-subtitle">Your saved cocktails and history</p>
                </div>

                <!-- Sub-tabs for Favorites -->
                <div class="action-buttons" style="margin-bottom: 24px;">
                    <button class="action-btn active" id="showFavoritesBtn">‚ù§Ô∏è Favorites</button>
                    <button class="action-btn" id="showMadeThisBtn">‚úì Made This</button>
                </div>

                <div id="favoritesListSection"></div>
                <div id="madeThisListSection" style="display: none;"></div>
            </div>

            <!-- Page: AI Assistant -->
            <div id="tab-ai" class="tab-content">
                <div class="page-header">
                    <h2 class="page-title">ü§ñ AI Bartender</h2>
                    <p class="page-subtitle">Your personal cocktail discovery assistant</p>
                </div>

                <div id="aiSearchSection" class="ai-search-section">
                    <!-- API Key Setup -->
                    <div class="api-key-section" id="apiKeySection">
                        <label for="apiKey">üîë Anthropic API Key:
                            <button class="collapse-btn" id="toggleApiKey">Show/Hide</button>
                        </label>
                        <input type="password" id="apiKey" placeholder="sk-ant-..." style="display: none;">
                        <div class="api-key-status" id="apiKeyStatus"></div>
                        <p style="font-size: 0.8125rem; margin-top: 8px; opacity: 0.9;">
                            Get your API key from <a href="https://console.anthropic.com" target="_blank" style="color: white; text-decoration: underline;">console.anthropic.com</a>
                        </p>
                    </div>

                    <!-- AI Context Info -->
                    <div class="ai-context-info">
                        <p><strong>üß† I know about:</strong></p>
                        <ul>
                            <li>Your complete bar inventory (all bottles & ingredients)</li>
                            <li>Your favorite cocktails and what you've made before</li>
                            <li>All recipes you can make right now</li>
                            <li>Tasting notes and profiles of your spirits</li>
                        </ul>
                    </div>

                    <!-- Query Input -->
                    <div class="ai-query-section">
                        <label for="aiQuery" style="font-weight: 600; margin-bottom: 8px; display: block;">
                            üí¨ Ask me anything about cocktails:
                        </label>
                        <p style="font-size: 0.8125rem; color: var(--text-secondary); margin-bottom: 12px;">
                            Press <strong>Enter</strong> to send ‚Ä¢ <strong>Shift+Enter</strong> for new line
                        </p>
                        <textarea id="aiQuery" placeholder="Type your question here...

Examples:
‚Ä¢ What's the best cocktail to make with my Smith & Cross rum?
‚Ä¢ I want something tropical and not too sweet
‚Ä¢ What's similar to a Mai Tai but uses whiskey?
‚Ä¢ Suggest a drink to impress guests who like gin
‚Ä¢ What can I make that's perfect for a hot day?
‚Ä¢ Show me an easy beginner tiki drink"></textarea>
                        <div class="ai-button-row">
                            <button id="aiQueryBtn" class="ai-query-btn">‚ú® Ask AI Bartender</button>
                            <button id="clearConversationBtn" class="btn-secondary btn-sm">‚Ü∫ New Conversation</button>
                        </div>
                    </div>

                    <!-- Inspiring Examples -->
                    <div class="ai-examples">
                        <strong>üí° Ask me to help you:</strong>
                        <div class="ai-examples-grid">
                            <div class="ai-example-card">
                                <strong>üîç Discover</strong>
                                <p>"What cocktails highlight my Navy strength rum?"</p>
                            </div>
                            <div class="ai-example-card">
                                <strong>üéØ Match Preferences</strong>
                                <p>"I like smoky, spirit-forward drinks"</p>
                            </div>
                            <div class="ai-example-card">
                                <strong>üå¥ Explore Styles</strong>
                                <p>"Show me authentic tiki drinks I can make"</p>
                            </div>
                            <div class="ai-example-card">
                                <strong>üìö Learn</strong>
                                <p>"What makes a Mai Tai different from a Zombie?"</p>
                            </div>
                            <div class="ai-example-card">
                                <strong>üîÑ Find Alternatives</strong>
                                <p>"I'm out of orgeat, what can I substitute?"</p>
                            </div>
                            <div class="ai-example-card">
                                <strong>üë• Entertain</strong>
                                <p>"What's a crowd-pleaser for non-cocktail people?"</p>
                            </div>
                        </div>
                    </div>

                    <!-- AI Response Area -->
                    <div id="aiSearchResponse" class="ai-response-area"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="recipeModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="modalClose">&times;</span>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // Application state
        const APP = {
            inventoryData: null,
            recipeData: [],
            currentInventory: null,
            allResults: null,
            apiKey: null,
            conversationHistory: [],
            favorites: new Set(),
            history: {},  // { recipeName: { hasMade: false, rating: 0, notes: '' } }
            editableInventory: [],
            // Search & Filter state
            activeFilters: {
                perfectMatches: false,
                missingOne: false
            },
            sortBy: 'compatibility',
            recentlyViewed: []  // Array of {name, timestamp}
        };

        // DOM elements
        const elements = {
            inventoryInput: document.getElementById('inventoryFile'),
            recipeInput: document.getElementById('recipeFile'),
            inventoryStatus: document.getElementById('inventoryStatus'),
            recipeStatus: document.getElementById('recipeStatus'),
            analyzeBtn: document.getElementById('analyzeBtn'),
            resultsDiv: document.getElementById('results'),
            modal: document.getElementById('recipeModal'),
            modalBody: document.getElementById('modalBody'),
            modalClose: document.getElementById('modalClose'),
            searchSection: document.getElementById('searchSection'),
            ingredientSelect: document.getElementById('ingredientSelect'),
            searchBtn: document.getElementById('searchBtn'),
            searchResponse: document.getElementById('searchResponse'),
            shoppingList: document.getElementById('shoppingList'),
            aiSearchSection: document.getElementById('aiSearchSection'),
            apiKeyInput: document.getElementById('apiKey'),
            apiKeyStatus: document.getElementById('apiKeyStatus'),
            toggleApiKey: document.getElementById('toggleApiKey'),
            aiQuery: document.getElementById('aiQuery'),
            aiQueryBtn: document.getElementById('aiQueryBtn'),
            aiSearchResponse: document.getElementById('aiSearchResponse'),
            clearConversationBtn: document.getElementById('clearConversationBtn'),
            favoritesSection: document.getElementById('favoritesSection'),
            inventoryManager: document.getElementById('inventoryManager'),
            // Search & Filter elements
            filterControls: document.getElementById('filterControls'),
            sortSelect: document.getElementById('sortSelect'),
            randomCocktailBtn: document.getElementById('randomCocktailBtn'),
            perfectMatchesBtn: document.getElementById('perfectMatchesBtn'),
            almostThereBtn: document.getElementById('almostThereBtn'),
            clearFiltersBtn: document.getElementById('clearFiltersBtn'),
            activeFiltersDiv: document.getElementById('activeFilters'),
            resultsCount: document.getElementById('resultsCount'),
            recentlyViewedSection: document.getElementById('recentlyViewedSection'),
            recentlyViewedList: document.getElementById('recentlyViewedList')
        };

        // Initialize event listeners
        function init() {
            elements.inventoryInput.addEventListener('change', handleInventoryUpload);
            elements.recipeInput.addEventListener('change', handleRecipeUpload);
            elements.analyzeBtn.addEventListener('click', analyze);
            elements.modalClose.addEventListener('click', closeModal);
            elements.modal.addEventListener('click', handleModalClick);
            elements.searchBtn.addEventListener('click', handleSearch);
            elements.toggleApiKey.addEventListener('click', toggleApiKeyVisibility);
            elements.apiKeyInput.addEventListener('input', saveApiKey);
            elements.aiQueryBtn.addEventListener('click', handleAIQuery);
            elements.clearConversationBtn.addEventListener('click', clearConversation);

            // Allow Enter key to submit AI query (Shift+Enter for new line)
            elements.aiQuery.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleAIQuery();
                }
            });

            // Setup backup/restore
            const exportDataBtn = document.getElementById('exportDataBtn');
            const importDataFile = document.getElementById('importDataFile');
            if (exportDataBtn) exportDataBtn.addEventListener('click', exportAllData);
            if (importDataFile) importDataFile.addEventListener('change', importAllData);

            // Setup tab navigation
            setupTabs();

            // Setup favorites sub-tabs
            setupFavoritesSubTabs();

            // Setup search & filter event listeners
            setupSearchAndFilters();

            // Load API key from localStorage
            loadApiKey();

            // Load favorites and history
            loadFavoritesAndHistory();

            // Load recently viewed
            loadRecentlyViewed();

            // Load saved inventory if exists
            if (loadSavedInventory()) {
                displayInventoryManager();
                // Convert saved inventory back to APP.inventoryData format
                if (APP.editableInventory.length > 0) {
                    APP.inventoryData = APP.editableInventory;
                }
            }

            // Load saved recipes if exists
            loadSavedRecipes();

            // Check if we have saved data to enable analyze button
            checkReady();
        }

        // ===== SEARCH & FILTER SETUP =====

        function setupSearchAndFilters() {
            if (elements.sortSelect) {
                elements.sortSelect.addEventListener('change', function() {
                    APP.sortBy = this.value;
                    refreshResults();
                });
            }

            if (elements.randomCocktailBtn) {
                elements.randomCocktailBtn.addEventListener('click', showRandomCocktail);
            }

            if (elements.perfectMatchesBtn) {
                elements.perfectMatchesBtn.addEventListener('click', function() {
                    APP.activeFilters.perfectMatches = !APP.activeFilters.perfectMatches;
                    refreshResults();
                });
            }

            if (elements.almostThereBtn) {
                elements.almostThereBtn.addEventListener('click', function() {
                    APP.activeFilters.missingOne = !APP.activeFilters.missingOne;
                    refreshResults();
                });
            }

            if (elements.clearFiltersBtn) {
                elements.clearFiltersBtn.addEventListener('click', clearAllFilters);
            }
        }

        function loadRecentlyViewed() {
            try {
                const saved = localStorage.getItem('cocktail_recentlyViewed');
                if (saved) {
                    APP.recentlyViewed = JSON.parse(saved);
                    displayRecentlyViewed();
                }
            } catch (error) {
                console.error('Error loading recently viewed:', error);
                APP.recentlyViewed = [];
            }
        }

        // ===== BACKUP & RESTORE =====

        function exportAllData() {
            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                favorites: Array.from(APP.favorites),
                history: APP.history,
                inventory: APP.editableInventory,
                recipes: APP.recipeData,
                apiKey: APP.apiKey
            };

            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateStr = new Date().toISOString().split('T')[0];
            a.download = `bartender-backup-${dateStr}.json`;
            a.click();
            URL.revokeObjectURL(url);

            alert('‚úì Backup exported successfully!');
        }

        function importAllData(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const backupData = JSON.parse(event.target.result);

                    // Restore favorites
                    if (backupData.favorites) {
                        APP.favorites = new Set(backupData.favorites);
                        localStorage.setItem('cocktail_favorites', JSON.stringify(backupData.favorites));
                    }

                    // Restore history
                    if (backupData.history) {
                        APP.history = backupData.history;
                        localStorage.setItem('cocktail_history', JSON.stringify(backupData.history));
                    }

                    // Restore inventory
                    if (backupData.inventory) {
                        APP.editableInventory = backupData.inventory;
                        APP.inventoryData = backupData.inventory;
                        localStorage.setItem('cocktail_inventory', JSON.stringify(backupData.inventory));
                    }

                    // Restore recipes
                    if (backupData.recipes) {
                        APP.recipeData = backupData.recipes;
                        localStorage.setItem('cocktail_recipes', JSON.stringify(backupData.recipes));
                    }

                    // Restore API key (optional)
                    if (backupData.apiKey) {
                        APP.apiKey = backupData.apiKey;
                        localStorage.setItem('cocktail_api_key', backupData.apiKey);
                    }

                    // Refresh displays
                    if (APP.editableInventory.length > 0) {
                        displayInventoryManager();
                    }
                    checkReady();

                    alert('‚úì Backup restored successfully! All your data has been imported.');

                    // Clear file input
                    e.target.value = '';
                } catch (error) {
                    alert('‚ùå Error importing backup: ' + error.message);
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        // ===== TAB NAVIGATION =====

        function setupFavoritesSubTabs() {
            const showFavoritesBtn = document.getElementById('showFavoritesBtn');
            const showMadeThisBtn = document.getElementById('showMadeThisBtn');

            if (showFavoritesBtn) {
                showFavoritesBtn.addEventListener('click', function() {
                    showFavoritesBtn.classList.add('active');
                    showMadeThisBtn.classList.remove('active');
                    document.getElementById('favoritesListSection').style.display = 'block';
                    document.getElementById('madeThisListSection').style.display = 'none';
                });
            }

            if (showMadeThisBtn) {
                showMadeThisBtn.addEventListener('click', function() {
                    showMadeThisBtn.classList.add('active');
                    showFavoritesBtn.classList.remove('active');
                    document.getElementById('favoritesListSection').style.display = 'none';
                    document.getElementById('madeThisListSection').style.display = 'block';
                });
            }
        }

        function setupTabs() {
            const tabs = document.querySelectorAll('.sidebar-nav-link');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    switchTab(targetTab);
                });
            });
        }

        function switchTab(tabName) {
            // Hide all tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Remove active from all sidebar links
            document.querySelectorAll('.sidebar-nav-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected tab content
            const targetContent = document.getElementById('tab-' + tabName);
            if (targetContent) {
                targetContent.classList.add('active');
            }

            // Add active to clicked sidebar link
            const activeLink = document.querySelector(`.sidebar-nav-link[data-tab="${tabName}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
            }

            // Refresh content for specific tabs
            if (tabName === 'mybar' && APP.editableInventory.length > 0) {
                displayInventoryManager();
            } else if (tabName === 'favorites') {
                displayFavorites();
            }
        }

        // ===== FAVORITES & HISTORY FUNCTIONS =====

        // Load favorites and history from localStorage
        function loadFavoritesAndHistory() {
            const savedFavorites = localStorage.getItem('cocktail_favorites');
            const savedHistory = localStorage.getItem('cocktail_history');

            if (savedFavorites) {
                APP.favorites = new Set(JSON.parse(savedFavorites));
            }

            if (savedHistory) {
                APP.history = JSON.parse(savedHistory);
            }
        }

        // Save favorites to localStorage
        function saveFavorites() {
            localStorage.setItem('cocktail_favorites', JSON.stringify(Array.from(APP.favorites)));
        }

        // Save history to localStorage
        function saveHistory() {
            localStorage.setItem('cocktail_history', JSON.stringify(APP.history));
        }

        // Toggle favorite
        function toggleFavorite(recipeName) {
            if (APP.favorites.has(recipeName)) {
                APP.favorites.delete(recipeName);
            } else {
                APP.favorites.add(recipeName);
            }
            saveFavorites();
            displayFavorites();

            // Update the heart icon if modal is open
            updateFavoriteButton(recipeName);
        }

        // Toggle "Made This" status
        function markAsMade(recipeName) {
            if (!APP.history[recipeName]) {
                APP.history[recipeName] = {
                    hasMade: false,
                    rating: 0,
                    notes: ''
                };
            }

            // Toggle the made status
            APP.history[recipeName].hasMade = !APP.history[recipeName].hasMade;
            saveHistory();

            // Update displays
            displayFavorites();
            updateMadeThisButton(recipeName);
        }

        // Set rating
        function setRating(recipeName, rating) {
            if (!APP.history[recipeName]) {
                APP.history[recipeName] = {
                    madeDates: [],
                    rating: 0,
                    notes: ''
                };
            }

            APP.history[recipeName].rating = rating;
            saveHistory();
            updateRatingDisplay(recipeName);
        }

        // Save notes
        function saveNotes(recipeName, notes) {
            if (!APP.history[recipeName]) {
                APP.history[recipeName] = {
                    madeDates: [],
                    rating: 0,
                    notes: ''
                };
            }

            APP.history[recipeName].notes = notes;
            saveHistory();
        }

        // Update favorite button in modal
        function updateFavoriteButton(recipeName) {
            const heartBtn = document.getElementById('favoriteBtn');
            if (heartBtn) {
                const isFavorite = APP.favorites.has(recipeName);
                heartBtn.textContent = isFavorite ? '‚ù§Ô∏è' : 'ü§ç';
                heartBtn.className = 'favorite-btn' + (isFavorite ? ' active' : '');
            }
        }

        // Update rating display
        function updateRatingDisplay(recipeName) {
            const ratingEl = document.getElementById('ratingStars');
            if (ratingEl && APP.history[recipeName]) {
                const rating = APP.history[recipeName].rating;
                const stars = ratingEl.querySelectorAll('span');
                stars.forEach((star, idx) => {
                    star.className = idx < rating ? 'filled' : '';
                });
            }
        }

        // Update made this button in modal
        function updateMadeThisButton(recipeName) {
            const madeBtn = document.getElementById('madeThisBtn');
            if (madeBtn && APP.history[recipeName]) {
                const hasMade = APP.history[recipeName].hasMade;
                madeBtn.textContent = hasMade ? '‚úì Made This' : '‚úì Mark as Made';
                madeBtn.style.background = hasMade ? 'var(--success)' : 'var(--primary)';
            }
        }

        // Display favorites section
        function displayFavorites() {
            const allRecipes = APP.allResults ?
                APP.allResults.perfect.concat(APP.allResults.veryGood, APP.allResults.good) : [];

            // Display Favorites List
            displayFavoritesList(allRecipes);

            // Display Made This List
            displayMadeThisList(allRecipes);
        }

        // Display favorites list
        function displayFavoritesList(allRecipes) {
            const favoritesListSection = document.getElementById('favoritesListSection');
            if (!favoritesListSection) return;

            if (APP.favorites.size === 0) {
                favoritesListSection.innerHTML = '<div class="card"><p style="color: var(--text-secondary);">No favorites yet. Click the heart on any recipe to add it here!</p></div>';
                return;
            }

            // Check if analysis has been run
            if (!APP.allResults || allRecipes.length === 0) {
                let html = '<div class="card">';
                html += '<p style="color: var(--text-secondary); margin-bottom: 12px;">You have <strong>' + APP.favorites.size + ' favorite(s)</strong> saved!</p>';
                html += '<p style="color: var(--text-secondary);">Run "Analyze My Bar" to see them here.</p>';
                html += '</div>';
                favoritesListSection.innerHTML = html;
                return;
            }

            const favoriteRecipes = allRecipes.filter(r => APP.favorites.has(r.name));

            let html = '';
            if (favoriteRecipes.length === 0) {
                html += '<div class="card">';
                html += '<p style="color: var(--text-secondary);">You have ' + APP.favorites.size + ' favorite(s) saved, but they\'re not in your current recipe collection.</p>';
                html += '<p style="color: var(--text-secondary); margin-top: 8px;">Try uploading different recipes or running analyze again.</p>';
                html += '</div>';
            } else {
                favoriteRecipes.forEach(function(recipe) {
                    const category = APP.allResults.perfect.includes(recipe) ? 'perfect' :
                                   APP.allResults.veryGood.includes(recipe) ? 'veryGood' : 'good';
                    const index = APP.allResults[category].indexOf(recipe);

                    html += createRecipeCard(recipe, category, index);
                });
            }

            favoritesListSection.innerHTML = html;

            // Add click handlers
            favoritesListSection.querySelectorAll('.recipe-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const category = this.dataset.category;
                    const index = parseInt(this.dataset.index);
                    showRecipe(category, index);
                });
            });
        }

        // Display made this list
        function displayMadeThisList(allRecipes) {
            const madeThisListSection = document.getElementById('madeThisListSection');
            if (!madeThisListSection) return;

            // Get all recipes marked as made
            const madeRecipeNames = Object.keys(APP.history).filter(name => {
                const h = APP.history[name];
                // Support both old format (madeDates) and new format (hasMade)
                return h.hasMade || (h.madeDates && h.madeDates.length > 0);
            });

            if (madeRecipeNames.length === 0) {
                madeThisListSection.innerHTML = '<div class="card"><p style="color: var(--text-secondary);">No recipes marked yet. Click "Made This" on any recipe to track it here!</p></div>';
                return;
            }

            // Check if analysis has been run
            if (!APP.allResults || allRecipes.length === 0) {
                let html = '<div class="card">';
                html += '<p style="color: var(--text-secondary); margin-bottom: 12px;">You have <strong>' + madeRecipeNames.length + ' recipe(s)</strong> marked as made!</p>';
                html += '<p style="color: var(--text-secondary);">Run "Analyze My Bar" to see them here.</p>';
                html += '</div>';
                madeThisListSection.innerHTML = html;
                return;
            }

            const madeRecipes = allRecipes.filter(r => madeRecipeNames.includes(r.name));

            let html = '';
            if (madeRecipes.length === 0) {
                html += '<div class="card">';
                html += '<p style="color: var(--text-secondary);">You have ' + madeRecipeNames.length + ' recipe(s) marked as made, but they\'re not in your current recipe collection.</p>';
                html += '<p style="color: var(--text-secondary); margin-top: 8px;">Try uploading different recipes or running analyze again.</p>';
                html += '</div>';
            } else {
                madeRecipes.forEach(function(recipe) {
                    const category = APP.allResults.perfect.includes(recipe) ? 'perfect' :
                                   APP.allResults.veryGood.includes(recipe) ? 'veryGood' : 'good';
                    const index = APP.allResults[category].indexOf(recipe);

                    html += createRecipeCard(recipe, category, index);
                });
            }

            madeThisListSection.innerHTML = html;

            // Add click handlers
            madeThisListSection.querySelectorAll('.recipe-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const category = this.dataset.category;
                    const index = parseInt(this.dataset.index);
                    showRecipe(category, index);
                });
            });
        }

        // ===== INVENTORY MANAGEMENT FUNCTIONS =====

        // Load inventory from localStorage
        function loadSavedInventory() {
            const saved = localStorage.getItem('cocktail_inventory');
            if (saved) {
                APP.editableInventory = JSON.parse(saved);
                return true;
            }
            return false;
        }

        // Save inventory to localStorage
        function saveInventory() {
            localStorage.setItem('cocktail_inventory', JSON.stringify(APP.editableInventory));
        }

        // Load recipes from localStorage
        function loadSavedRecipes() {
            const saved = localStorage.getItem('cocktail_recipes');
            if (saved) {
                APP.recipeData = JSON.parse(saved);
                return true;
            }
            return false;
        }

        // Save recipes to localStorage
        function saveRecipes() {
            if (APP.recipeData && APP.recipeData.length > 0) {
                localStorage.setItem('cocktail_recipes', JSON.stringify(APP.recipeData));
            }
        }

        // Display inventory manager
        function displayInventoryManager() {
            let html = '<div class="search-title">üì¶ Manage Your Bar Stock</div>';
            html += '<div style="margin-bottom: 15px; opacity: 0.95;">Add or remove ingredients. Changes update your recipes instantly!</div>';

            html += '<div class="inventory-list">';
            APP.editableInventory.forEach(function(item, idx) {
                // Handle both old string format and new object format
                const isObject = typeof item === 'object';
                const name = isObject ? item.Name : item;

                html += '<div class="inventory-item-rich">';
                html += '<div class="inventory-item-details">';
                html += '<div class="inventory-item-name">' + escapeHtml(name) + '</div>';

                if (isObject) {
                    // Line 1: Type and Classification
                    const line1 = [];
                    if (item['Liquor Type']) line1.push(escapeHtml(item['Liquor Type']));
                    if (item['Detailed Spirit Classification']) line1.push(escapeHtml(item['Detailed Spirit Classification']));
                    if (line1.length > 0) {
                        html += '<div class="inventory-item-secondary">' + line1.join(' ‚Ä¢ ') + '</div>';
                    }

                    // Line 2: Location, ABV, Age
                    const line2 = [];
                    if (item['Distillery Location']) line2.push(escapeHtml(item['Distillery Location']));
                    if (item['ABV (%)']) line2.push(escapeHtml(item['ABV (%)']) + '%');
                    if (item['Age Statement or Barrel Finish']) line2.push(escapeHtml(item['Age Statement or Barrel Finish']));
                    if (line2.length > 0) {
                        html += '<div class="inventory-item-secondary">' + line2.join(' ‚Ä¢ ') + '</div>';
                    }

                    // Distillation Method
                    if (item['Distillation Method']) {
                        html += '<div class="inventory-item-secondary">Method: ' + escapeHtml(item['Distillation Method']) + '</div>';
                    }

                    // Tasting Profile
                    if (item['Profile (Nose)'] || item.Palate || item.Finish) {
                        html += '<div class="inventory-tasting-profile">';
                        if (item['Profile (Nose)']) {
                            html += '<div><strong>Nose:</strong> ' + escapeHtml(item['Profile (Nose)']) + '</div>';
                        }
                        if (item.Palate) {
                            html += '<div><strong>Palate:</strong> ' + escapeHtml(item.Palate) + '</div>';
                        }
                        if (item.Finish) {
                            html += '<div><strong>Finish:</strong> ' + escapeHtml(item.Finish) + '</div>';
                        }
                        html += '</div>';
                    }

                    // Additional Notes
                    if (item['Additional Notes']) {
                        html += '<div class="inventory-item-notes">üìù ' + escapeHtml(item['Additional Notes']) + '</div>';
                    }
                }

                html += '</div>';
                html += '<button class="inventory-remove-btn" data-index="' + idx + '">Remove</button>';
                html += '</div>';
            });
            html += '</div>';

            html += '<div class="inventory-add-section">';
            html += '<input type="text" id="newIngredientInput" class="inventory-add-input" placeholder="Add ingredient name (e.g., Hamilton 86)">';
            html += '<button class="inventory-add-btn" id="addIngredientBtn">Add</button>';
            html += '</div>';

            html += '<div style="margin-top: 20px; background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; text-align: center;">';
            html += '<strong>Total Ingredients: ' + APP.editableInventory.length + '</strong>';
            html += '</div>';

            elements.inventoryManager.innerHTML = html;
            elements.inventoryManager.style.display = 'block';

            // Add event listeners
            const removeButtons = elements.inventoryManager.querySelectorAll('.inventory-remove-btn');
            removeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    removeIngredient(parseInt(this.getAttribute('data-index')));
                });
            });

            const addBtn = document.getElementById('addIngredientBtn');
            if (addBtn) {
                addBtn.addEventListener('click', addIngredient);
            }
        }

        // Add ingredient
        function addIngredient() {
            const input = document.getElementById('newIngredientInput');
            const newItem = input.value.trim();

            if (!newItem) {
                alert('Please enter an ingredient name');
                return;
            }

            // Check for duplicates - handle both string and object formats
            const isDuplicate = APP.editableInventory.some(item => {
                const itemName = typeof item === 'object' ? item.Name : item;
                return itemName.toLowerCase() === newItem.toLowerCase();
            });

            if (isDuplicate) {
                alert('This ingredient is already in your inventory');
                return;
            }

            // Create a bottle object with name and empty metadata for all 12 columns
            // User can add details via CSV or future enhancement
            const newBottle = {
                'Liquor Type': '',
                'Name': newItem,
                'Stock Number': 1,
                'Detailed Spirit Classification': '',
                'Distillation Method': '',
                'ABV (%)': '',
                'Distillery Location': '',
                'Age Statement or Barrel Finish': '',
                'Additional Notes': '',
                'Profile (Nose)': '',
                'Palate': '',
                'Finish': ''
            };

            APP.editableInventory.push(newBottle);
            saveInventory();
            input.value = '';

            // Re-analyze with new inventory
            reanalyzeWithCurrentInventory();
        }

        // Remove ingredient
        function removeIngredient(index) {
            const item = APP.editableInventory[index];
            // Handle both string and object formats
            const itemName = typeof item === 'object' ? item.Name : item;

            if (confirm('Remove "' + itemName + '" from your bar?')) {
                APP.editableInventory.splice(index, 1);
                saveInventory();

                // Re-analyze with updated inventory
                reanalyzeWithCurrentInventory();
            }
        }

        // Re-analyze with current inventory
        function reanalyzeWithCurrentInventory() {
            if (!APP.recipeData || APP.recipeData.length === 0) {
                alert('Please upload recipes first');
                return;
            }

            // Convert editable inventory to the format expected by analysis
            // Handle both string and object formats
            const fakeInventoryData = APP.editableInventory.map(item => {
                if (typeof item === 'object') {
                    // Already an object with all data, ensure Stock Number is set
                    return {
                        ...item,
                        'Stock Number': item['Stock Number'] || 1
                    };
                } else {
                    // Old string format, convert to minimal object
                    return {
                        Name: item,
                        'Stock Number': 1
                    };
                }
            });

            const results = runAnalysis(fakeInventoryData, APP.recipeData);
            displayResults(results);
            displayFavorites();
            displayInventoryManager();
            generateShoppingList(results);
            setupSearch();
        }

        // Export inventory as CSV
        function exportInventory() {
            // CSV header with all 12 columns matching user's format
            const header = 'Liquor Type,Name,Stock Number,Detailed Spirit Classification,Distillation Method,ABV (%),Distillery Location,Age Statement or Barrel Finish,Additional Notes,Profile (Nose),Palate,Finish\n';

            // Helper to escape CSV values
            const escapeCsv = val => {
                if (!val && val !== 0) return '';
                const str = String(val);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return '"' + str.replace(/"/g, '""') + '"';
                }
                return str;
            };

            // Convert inventory items to CSV rows
            const rows = APP.editableInventory.map(item => {
                if (typeof item === 'object') {
                    return [
                        escapeCsv(item['Liquor Type'] || ''),
                        escapeCsv(item.Name || ''),
                        escapeCsv(item['Stock Number'] || 1),
                        escapeCsv(item['Detailed Spirit Classification'] || ''),
                        escapeCsv(item['Distillation Method'] || ''),
                        escapeCsv(item['ABV (%)'] || ''),
                        escapeCsv(item['Distillery Location'] || ''),
                        escapeCsv(item['Age Statement or Barrel Finish'] || ''),
                        escapeCsv(item['Additional Notes'] || ''),
                        escapeCsv(item['Profile (Nose)'] || ''),
                        escapeCsv(item.Palate || ''),
                        escapeCsv(item.Finish || '')
                    ].join(',');
                } else {
                    // Old string format - just export name
                    return `,${item},1,,,,,,,,,`;
                }
            });

            const csv = header + rows.join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'my-bar-inventory.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Clear conversation history
        function clearConversation() {
            APP.conversationHistory = [];
            elements.aiSearchResponse.innerHTML = '<div style="padding: 20px; color: #333;">Conversation cleared. Start fresh!</div>';
            elements.aiSearchResponse.classList.add('active');
        }

        // Handle inventory file upload
        function handleInventoryUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            elements.inventoryStatus.textContent = 'Loading...';
            elements.inventoryStatus.className = 'file-status';

            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        showError('Error parsing inventory file: ' + results.errors[0].message);
                        elements.inventoryStatus.textContent = '‚ùå Error loading file';
                        elements.inventoryStatus.className = 'file-status error';
                        return;
                    }

                    // Validate CSV structure
                    if (!results.data || results.data.length === 0) {
                        showError('Inventory file is empty');
                        elements.inventoryStatus.textContent = '‚ùå File is empty';
                        elements.inventoryStatus.className = 'file-status error';
                        return;
                    }

                    const firstRow = results.data[0];
                    if (!firstRow.Name || firstRow['Stock Number'] === undefined) {
                        showError('Inventory CSV must have "Name" and "Stock Number" columns');
                        elements.inventoryStatus.textContent = '‚ùå Invalid format';
                        elements.inventoryStatus.className = 'file-status error';
                        return;
                    }

                    APP.inventoryData = results.data;
                    elements.inventoryStatus.textContent = '‚úì Loaded ' + results.data.filter(item => item['Stock Number'] > 0).length + ' items in stock';
                    elements.inventoryStatus.className = 'file-status success';
                    checkReady();
                },
                error: function(error) {
                    showError('Failed to read inventory file: ' + error.message);
                    elements.inventoryStatus.textContent = '‚ùå Error loading file';
                    elements.inventoryStatus.className = 'file-status error';
                }
            });
        }

        // Handle recipe file upload
        function handleRecipeUpload(e) {
            const files = Array.from(e.target.files);
            if (files.length === 0) return;

            APP.recipeData = [];
            let filesProcessed = 0;
            let totalRecipes = 0;
            let hasErrors = false;

            elements.recipeStatus.textContent = 'Loading ' + files.length + ' file(s)...';
            elements.recipeStatus.className = 'file-status';

            files.forEach(function(file) {
                Papa.parse(file, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        if (results.errors.length > 0) {
                            console.error('Error parsing ' + file.name + ':', results.errors);
                            hasErrors = true;
                        }

                        // Validate CSV structure
                        if (results.data && results.data.length > 0) {
                            const firstRow = results.data[0];
                            if (!firstRow['Drink Name'] || !firstRow.Ingredients) {
                                console.error('Invalid recipe file format:', file.name);
                                hasErrors = true;
                            } else {
                                APP.recipeData = APP.recipeData.concat(results.data);
                                totalRecipes += results.data.length;
                            }
                        }

                        filesProcessed++;

                        if (filesProcessed === files.length) {
                            if (hasErrors) {
                                elements.recipeStatus.textContent = '‚ö† Loaded ' + totalRecipes + ' recipes (some files had errors)';
                                elements.recipeStatus.className = 'file-status error';
                            } else {
                                elements.recipeStatus.textContent = '‚úì Loaded ' + totalRecipes + ' recipes from ' + files.length + ' file(s)';
                                elements.recipeStatus.className = 'file-status success';
                            }
                            checkReady();
                        }
                    },
                    error: function(error) {
                        console.error('Failed to read ' + file.name + ':', error);
                        hasErrors = true;
                        filesProcessed++;

                        if (filesProcessed === files.length) {
                            elements.recipeStatus.textContent = '‚ùå Error loading recipe files';
                            elements.recipeStatus.className = 'file-status error';
                        }
                    }
                });
            });
        }

        // Check if ready to analyze
        function checkReady() {
            const hasInventory = (APP.inventoryData && APP.inventoryData.length > 0) ||
                                 (APP.editableInventory && APP.editableInventory.length > 0);
            const hasRecipes = APP.recipeData && APP.recipeData.length > 0;

            if (hasInventory && hasRecipes) {
                elements.analyzeBtn.disabled = false;
                updateDataStatus();
            } else {
                updateDataStatus();
            }
        }

        // Update data status on home page
        function updateDataStatus() {
            const inventoryCount = APP.editableInventory?.length || 0;
            const recipeCount = APP.recipeData?.length || 0;

            let statusHTML = '<div style="margin-top: 16px; padding: 16px; background: var(--bg-tertiary); border-radius: 8px; font-size: 0.875rem;">';
            statusHTML += '<div style="margin-bottom: 8px;"><strong>Current Status:</strong></div>';

            if (inventoryCount > 0) {
                statusHTML += '<div style="color: var(--success);">‚úì Bar Stock: ' + inventoryCount + ' bottles loaded</div>';
            } else {
                statusHTML += '<div style="color: var(--text-secondary);">‚óã Bar Stock: No bottles loaded</div>';
            }

            if (recipeCount > 0) {
                statusHTML += '<div style="color: var(--success);">‚úì Recipes: ' + recipeCount + ' cocktails loaded</div>';
            } else {
                statusHTML += '<div style="color: var(--text-secondary);">‚óã Recipes: No recipes loaded</div>';
            }

            statusHTML += '</div>';

            const existingStatus = document.getElementById('dataStatus');
            if (existingStatus) {
                existingStatus.innerHTML = statusHTML;
            } else {
                const statusDiv = document.createElement('div');
                statusDiv.id = 'dataStatus';
                statusDiv.innerHTML = statusHTML;
                const uploadSection = document.querySelector('.upload-section');
                if (uploadSection) {
                    uploadSection.insertAdjacentElement('afterend', statusDiv);
                }
            }
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;

            elements.resultsDiv.innerHTML = '';
            elements.resultsDiv.appendChild(errorDiv);
        }

        // Main analysis function
        function analyze() {
            elements.resultsDiv.innerHTML = '<div class="loading">üîç Analyzing your bar...</div>';

            setTimeout(function() {
                try {
                    // Use inventory from either new upload or saved data
                    let inventoryToUse;

                    if (APP.inventoryData && APP.inventoryData.length > 0) {
                        // New CSV was uploaded - process it
                        APP.editableInventory = APP.inventoryData
                            .filter(item => item['Stock Number'] > 0)
                            .map(item => ({
                                'Liquor Type': item['Liquor Type'] || '',
                                'Name': item.Name || '',
                                'Stock Number': item['Stock Number'] || 1,
                                'Detailed Spirit Classification': item['Detailed Spirit Classification'] || '',
                                'Distillation Method': item['Distillation Method'] || '',
                                'ABV (%)': item['ABV (%)'] || '',
                                'Distillery Location': item['Distillery Location'] || '',
                                'Age Statement or Barrel Finish': item['Age Statement or Barrel Finish'] || '',
                                'Additional Notes': item['Additional Notes'] || '',
                                'Profile (Nose)': item['Profile (Nose)'] || '',
                                'Palate': item.Palate || '',
                                'Finish': item.Finish || '',
                                // Preserve any other columns not explicitly listed
                                ...item
                            }));
                        saveInventory();
                        inventoryToUse = APP.inventoryData;
                    } else if (APP.editableInventory && APP.editableInventory.length > 0) {
                        // Use saved inventory from My Bar
                        inventoryToUse = APP.editableInventory;
                    } else {
                        showError('No inventory data available. Please upload bar stock CSV or add bottles to My Bar.');
                        return;
                    }

                    const results = runAnalysis(inventoryToUse, APP.recipeData);
                    refreshResults();  // Display with filters
                    displayFavorites();
                    displayInventoryManager();
                    displayRecentlyViewed();
                    generateShoppingList(results);
                    setupSearch();

                    // Save recipes to localStorage for next time
                    saveRecipes();

                    // Analysis complete - user can now navigate to other tabs
                } catch (error) {
                    showError('Analysis failed: ' + error.message);
                    console.error('Analysis error:', error);
                }
            }, 300);
        }

        // ===== FUZZY MATCHING FUNCTIONS =====

        // Calculate string similarity (0-1, higher is more similar)
        function stringSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;

            if (longer.length === 0) return 1.0;

            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        // Levenshtein distance algorithm
        function levenshteinDistance(str1, str2) {
            const matrix = [];

            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }

            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }

            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }

            return matrix[str2.length][str1.length];
        }

        // Normalize string for fuzzy matching
        function fuzzyNormalize(str) {
            return str.toLowerCase()
                .replace(/[^a-z0-9]/g, '') // Remove all non-alphanumeric
                .trim();
        }

        // Check if two ingredients are similar (handles spacing, punctuation)
        function areSimilarIngredients(ing1, ing2, threshold = 0.85) {
            const norm1 = fuzzyNormalize(ing1);
            const norm2 = fuzzyNormalize(ing2);

            // Exact match after normalization
            if (norm1 === norm2) return true;

            // One contains the other
            if (norm1.includes(norm2) || norm2.includes(norm1)) return true;

            // Check similarity score
            const similarity = stringSimilarity(norm1, norm2);
            return similarity >= threshold;
        }

        // ===== AI SEARCH FUNCTIONS =====

        // Load API key from localStorage
        function loadApiKey() {
            const savedKey = localStorage.getItem('anthropic_api_key');
            if (savedKey) {
                APP.apiKey = savedKey;
                elements.apiKeyInput.value = savedKey;
                elements.apiKeyStatus.textContent = '‚úì API key loaded';
                elements.apiKeyStatus.style.color = '#90EE90';
            } else {
                elements.apiKeyStatus.textContent = 'No API key saved. Enter one to use AI search.';
                elements.apiKeyStatus.style.color = '#FFD700';
            }
        }

        // Save API key to localStorage
        function saveApiKey() {
            const key = elements.apiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('anthropic_api_key', key);
                APP.apiKey = key;
                elements.apiKeyStatus.textContent = '‚úì API key saved';
                elements.apiKeyStatus.style.color = '#90EE90';
            } else {
                localStorage.removeItem('anthropic_api_key');
                APP.apiKey = null;
                elements.apiKeyStatus.textContent = 'API key cleared';
                elements.apiKeyStatus.style.color = '#FFD700';
            }
        }

        // Toggle API key visibility
        function toggleApiKeyVisibility() {
            const input = elements.apiKeyInput;
            if (input.style.display === 'none') {
                input.style.display = 'block';
            } else {
                input.style.display = 'none';
            }
        }

        // Handle AI query
        async function handleAIQuery() {
            const query = elements.aiQuery.value.trim();

            if (!query) {
                alert('Please enter a question or search query');
                return;
            }

            if (!APP.apiKey) {
                alert('Please enter your Anthropic API key first');
                elements.apiKeyInput.style.display = 'block';
                elements.apiKeyInput.focus();
                return;
            }

            if (!APP.allResults) {
                alert('Please analyze your bar first before using AI search');
                return;
            }

            // Disable button and show loading
            elements.aiQueryBtn.disabled = true;
            elements.aiSearchResponse.innerHTML = '<div style="padding: 20px; text-align: center;">ü§î AI is thinking...</div>';
            elements.aiSearchResponse.classList.add('active');

            // Clear input for next question
            elements.aiQuery.value = '';

            try {
                const result = await queryClaudeAPI(query);
                displayAIRecommendations(result);
            } catch (error) {
                elements.aiSearchResponse.innerHTML = '<div style="padding: 20px; color: #721c24; background: #f8d7da; border-radius: 8px;">‚ùå Error: ' + escapeHtml(error.message) + '</div>';
            } finally {
                elements.aiQueryBtn.disabled = false;
                elements.aiQuery.focus(); // Focus back on input for easy follow-up
            }
        }

        // Query Claude API via proxy server
        async function queryClaudeAPI(userQuery) {
            // Prepare cocktail data for Claude
            const allRecipes = APP.allResults.perfect.concat(APP.allResults.veryGood, APP.allResults.good);

            // Build inventory context with tasting notes
            let inventoryContext = "\n=== USER'S BAR INVENTORY ===\n";
            if (APP.editableInventory && APP.editableInventory.length > 0) {
                const spirits = APP.editableInventory.slice(0, 40); // Limit to first 40 bottles
                spirits.forEach(item => {
                    let itemDesc = `${item.Name || 'Unknown'}`;
                    if (item['Liquor Type']) itemDesc += ` (${item['Liquor Type']})`;
                    if (item['Detailed Spirit Classification']) itemDesc += ` - ${item['Detailed Spirit Classification']}`;

                    // Add tasting notes if available
                    const notes = [];
                    if (item['Profile (Nose)']) notes.push(`Nose: ${item['Profile (Nose)']}`);
                    if (item['Palate']) notes.push(`Palate: ${item['Palate']}`);
                    if (item['Finish']) notes.push(`Finish: ${item['Finish']}`);
                    if (notes.length > 0) itemDesc += ` | ${notes.join(', ')}`;

                    inventoryContext += `- ${itemDesc}\n`;
                });
            }

            // Build favorites context
            let favoritesContext = "";
            if (APP.favorites.size > 0) {
                favoritesContext = "\n=== USER'S FAVORITE COCKTAILS ===\n";
                Array.from(APP.favorites).slice(0, 10).forEach(name => {
                    favoritesContext += `- ${name}\n`;
                });
            }

            // Build history context
            let historyContext = "";
            const madeRecipes = Object.keys(APP.history).filter(name => APP.history[name].hasMade);
            if (madeRecipes.length > 0) {
                historyContext = "\n=== COCKTAILS USER HAS MADE ===\n";
                madeRecipes.slice(0, 15).forEach(name => {
                    const hist = APP.history[name];
                    let line = `- ${name}`;
                    if (hist.rating) line += ` (‚≠ê${hist.rating}/5)`;
                    if (hist.notes) line += ` - "${hist.notes.substring(0, 50)}"`;
                    historyContext += line + "\n";
                });
            }

            // Create compact recipe list
            const recipeList = allRecipes.map(r => {
                // Get main spirits/ingredients only (first 3-4 ingredients)
                const ingredientLines = r.fullRecipe.Ingredients.split('\n').slice(0, 4);
                const mainIngredients = ingredientLines.map(line => {
                    // Extract ingredient name without measurements
                    return line.replace(/^\d+[\s\/]*\d*[\s\/]*\d*\s*/, '')
                               .replace(/ounces?|oz|teaspoons?|tsp|tablespoons?|tbsp|dash(es)?|drops?|cups?|ml|cl/gi, '')
                               .trim();
                }).join(', ');

                return `${r.name} (${r.compatibility}% match) - ${mainIngredients}`;
            });

            // Limit to top 30 recipes
            const topRecipes = recipeList.slice(0, 30);

            const systemPrompt = `You are a friendly, expert bartender helping someone explore cocktails they can make from their home bar. You have deep knowledge of spirits, flavor profiles, and cocktail history.
${inventoryContext}${favoritesContext}${historyContext}
=== MAKEABLE COCKTAILS ===
${topRecipes.join('\n')}

GUIDELINES:
- Reference specific bottles from their inventory when relevant (especially tasting notes)
- Consider their favorites and past ratings when making recommendations
- Suggest drinks that match their preferences and experience level
- Be conversational and enthusiastic, but concise
- Explain WHY you're recommending something
- If they ask about a specific spirit, reference its exact name and profile from their inventory

At the end of your response, include "RECOMMENDATIONS:" followed by a JSON array of 3-5 exact cocktail names from the makeable cocktails list.

Example:
I see you have Smith & Cross Navy Strength rum with those funky, high-ester notes of ripe banana and molasses. That would be PERFECT in a Mai Tai or Zombie - those drinks were designed for bold Jamaican rums like this! Since you loved the Mai Tai before (gave it 5 stars!), you might also enjoy a Jungle Bird which has similar tropical vibes but adds Campari for complexity.

RECOMMENDATIONS: ["Mai Tai", "Zombie", "Jungle Bird"]`;

            // Build conversation messages
            const messages = [];

            // Add system context as first user message
            if (APP.conversationHistory.length === 0) {
                messages.push({
                    role: 'user',
                    content: systemPrompt
                });
                messages.push({
                    role: 'assistant',
                    content: "I'm ready to help you find the perfect cocktail! What are you in the mood for?"
                });
            }

            // Add conversation history
            APP.conversationHistory.forEach(msg => messages.push(msg));

            // Add current query
            messages.push({
                role: 'user',
                content: userQuery
            });

            // Use proxy server to keep API key secure
            const proxyUrl = 'http://localhost:3000/api/messages';

            const response = await fetch(proxyUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': APP.apiKey
                },
                body: JSON.stringify({
                    model: 'claude-3-haiku-20240307',
                    max_tokens: 1024,
                    system: systemPrompt,
                    messages: messages
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                let errorMessage = 'API request failed';

                try {
                    const error = JSON.parse(errorText);
                    errorMessage = error.error?.message || error.error || errorMessage;
                } catch (e) {
                    errorMessage = errorText || errorMessage;
                }

                // Check if it's a connection error
                if (errorMessage.includes('Failed to fetch') || errorMessage.includes('NetworkError')) {
                    throw new Error('Cannot connect to proxy server. Make sure to run: node proxy-server.js');
                }

                throw new Error(errorMessage);
            }

            const data = await response.json();
            const content = data.content[0].text;

            // Save to conversation history
            APP.conversationHistory.push({
                role: 'user',
                content: userQuery
            });
            APP.conversationHistory.push({
                role: 'assistant',
                content: content
            });

            // Extract recommendations and explanation
            let explanation = content;
            let recommendations = [];

            // Look for RECOMMENDATIONS: line
            const recoMatch = content.match(/RECOMMENDATIONS:\s*(\[.*?\])/);
            if (recoMatch) {
                try {
                    recommendations = JSON.parse(recoMatch[1]);
                    // Remove recommendations line from explanation
                    explanation = content.replace(/RECOMMENDATIONS:.*$/s, '').trim();
                } catch (e) {
                    console.error('Failed to parse recommendations:', e);
                }
            }

            return {
                explanation: explanation,
                recommendations: recommendations
            };
        }

        // Display AI recommendations
        function displayAIRecommendations(result) {
            const { explanation, recommendations } = result;

            let html = '';

            // Show AI's explanation
            if (explanation) {
                html += '<div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; color: #333; line-height: 1.6;">';
                html += '<div style="font-weight: bold; margin-bottom: 10px; color: #667eea; font-size: 1.1em;">ü§ñ Bartender AI:</div>';
                html += '<div style="white-space: pre-wrap;">' + escapeHtml(explanation) + '</div>';
                html += '</div>';
            }

            // Show clickable recommendations if any
            if (recommendations && recommendations.length > 0) {
                const allRecipes = APP.allResults.perfect.concat(APP.allResults.veryGood, APP.allResults.good);

                html += '<div style="font-weight: bold; margin-bottom: 15px; color: #333; background: white; padding: 15px; border-radius: 10px;">üìã Recommended Cocktails (click to view):</div>';

                recommendations.forEach(function(recipeName, idx) {
                    // Find the recipe (fuzzy match since AI might not get exact name)
                    let recipe = allRecipes.find(r => r.name.toLowerCase() === recipeName.toLowerCase());

                    if (!recipe) {
                        // Try fuzzy matching
                        recipe = allRecipes.find(r => areSimilarIngredients(r.name, recipeName, 0.7));
                    }

                    if (recipe) {
                        const category = APP.allResults.perfect.includes(recipe) ? 'perfect' :
                                       APP.allResults.veryGood.includes(recipe) ? 'veryGood' : 'good';
                        const index = APP.allResults[category].indexOf(recipe);

                        html += '<div style="margin-bottom: 5px; color: #666; font-size: 0.9em; background: white; padding: 5px 15px;">#' + (idx + 1) + '</div>';
                        html += createRecipeCard(recipe, category, index);
                    }
                });
            }

            // Add prompt for follow-up
            html += '<div style="background: rgba(255,255,255,0.5); padding: 15px; border-radius: 10px; margin-top: 20px; color: #333; font-style: italic; text-align: center;">';
            html += 'üí¨ Keep chatting! Ask follow-up questions or refine your search.';
            html += '</div>';

            elements.aiSearchResponse.innerHTML = html;

            // Add click handlers
            elements.aiSearchResponse.querySelectorAll('.recipe-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const category = this.dataset.category;
                    const index = parseInt(this.dataset.index);
                    showRecipe(category, index);
                });
            });
        }

        // Create ingredient aliases mapping
        function createAliasMap(inventory) {
            const inv = new Map();

            inventory.filter(item => item['Stock Number'] > 0).forEach(function(item) {
                const name = item.Name.toLowerCase();
                inv.set(name, true);

                // Add aliases for common ingredient variations
                addAliases(inv, name);
            });

            // Common ingredients assumed available
            const commonItems = ['ice', 'crushed ice', 'ice cubes', 'sugar', 'water', 'salt', 'mint', 'fresh mint'];
            commonItems.forEach(item => inv.set(item, true));

            return inv;
        }

        // Add ingredient aliases
        function addAliases(inv, name) {
            // Rum aliases
            if (name.includes('cruzan single barrel')) {
                ['aged rum', 'gold rum', 'virgin islands rum', 'gold virgin islands rum',
                 'dark rum', 'aged virgin islands rum', 'gold barbados rum'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('cruzan 151')) {
                ['151-proof caribbean rum', 'amber 151-proof rum', '151-proof rum'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('cruzan') && name.includes('light')) {
                ['light rum', 'light puerto rican rum', 'light virgin islands rum', 'white rum'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('hamilton 86')) {
                ['gold rum', 'demerara rum', 'gold puerto rican rum', '86-proof demerara rum'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('hamilton jamaican')) {
                ['dark jamaican rum', 'dark rum', 'jamaican rum'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('hamilton 151')) {
                ['lemon hart 151', 'lemon hart 151-proof demerara rum', '151-proof demerara rum'].forEach(alias => inv.set(alias, true));
            }

            // Liqueur aliases
            if (name.includes('cura√ßao') || name.includes('curacao')) {
                ['orange curacao', 'orange cura√ßao'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('banana')) {
                ['creme de banana', 'banana liqueur', 'cr√®me de banane'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('raspberry')) {
                ['raspberry liqueur', 'raspberry syrup'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('blackberry')) {
                ['blackberry brandy', 'blackberry liqueur'].forEach(alias => inv.set(alias, true));
            }

            // Syrup aliases
            if (name.includes('simple syrup') || name.includes('sugar syrup')) {
                ['simple syrup', 'sugar syrup', 'rock candy syrup'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('orgeat')) {
                ['orgeat syrup', 'orgeat'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('grenadine')) {
                inv.set('grenadine', true);
            }
            if (name.includes('demerara') && name.includes('syrup')) {
                ['demerara sugar syrup', 'demerara syrup'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('falernum')) {
                ['falernum', 'velvet falernum'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('passion')) {
                ['passion fruit syrup', 'passionfruit syrup', 'passion fruit', 'passionfruit'].forEach(alias => inv.set(alias, true));
            }

            // Juice aliases
            if (name.includes('lime') && !name.includes('sublime')) {
                ['lime juice', 'fresh lime juice'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('lemon') && name.includes('juice')) {
                ['lemon juice', 'fresh lemon juice'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('pineapple')) {
                ['pineapple juice', 'unsweetened pineapple juice'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('orange') && name.includes('juice')) {
                ['orange juice', 'fresh orange juice'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('grapefruit')) {
                ['grapefruit juice', 'fresh grapefruit juice'].forEach(alias => inv.set(alias, true));
            }

            // Bitters aliases
            if (name.includes('angostura')) {
                inv.set('angostura bitters', true);
            }

            // Mixer aliases
            if (name.includes('ginger beer')) {
                ['ginger beer', 'chilled ginger beer'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('sparkling water') || name.includes('club soda') || name.includes('soda water')) {
                ['club soda', 'soda water', 'chilled club soda', 'sparkling water'].forEach(alias => inv.set(alias, true));
            }
            if (name.includes('pernod')) {
                inv.set('pernod', true);
            }
            if (name.includes('absinthe')) {
                ['absinthe', 'pernod'].forEach(alias => inv.set(alias, true));
            }
        }

        // Normalize ingredient name for matching
        function normalizeIngredient(ingredientLine) {
            return ingredientLine.toLowerCase()
                .replace(/^\d+[\s\/]*\d*[\s\/]*\d*\s*/, '') // Remove measurements
                .replace(/ounces?|oz|teaspoons?|tsp|tablespoons?|tbsp|dash(es)?|drops?|cups?|ml|cl/gi, '')
                .replace(/fresh|chilled|cold|room temperature|hot/gi, '')
                .trim();
        }

        // Check if ingredient is in inventory
        function hasIngredient(ingredientLine, inventory) {
            // Skip garnish items
            if (ingredientLine.toLowerCase().includes('garnish')) {
                return true;
            }

            const normalized = normalizeIngredient(ingredientLine);

            // Direct match
            if (inventory.has(normalized)) {
                return true;
            }

            // Partial match (ingredient contains or is contained by inventory item)
            for (const [invItem] of inventory) {
                if (normalized.includes(invItem) || invItem.includes(normalized)) {
                    return true;
                }

                // Fuzzy match for spelling variations (e.g., "passionfruit" vs "passion fruit")
                if (areSimilarIngredients(normalized, invItem, 0.9)) {
                    return true;
                }
            }

            return false;
        }

        // Main analysis logic
        function runAnalysis(inventory, recipes) {
            const inv = createAliasMap(inventory);
            APP.currentInventory = inv;

            const results = { perfect: [], veryGood: [], good: [] };

            recipes.forEach(function(recipe) {
                if (!recipe.Ingredients || !recipe['Drink Name']) return;

                const lines = recipe.Ingredients.split('\n').filter(l => l.trim());
                let matches = 0;
                const missing = [];
                const matched = [];

                lines.forEach(function(line) {
                    const trimmedLine = line.trim();
                    if (!trimmedLine) return;

                    if (hasIngredient(trimmedLine, inv)) {
                        matches++;
                        matched.push(trimmedLine);
                    } else {
                        missing.push(trimmedLine);
                    }
                });

                const total = matches + missing.length;
                const compatibility = total > 0 ? Math.round((matches / total) * 100) : 0;

                const analysis = {
                    name: recipe['Drink Name'],
                    compatibility: compatibility,
                    matches: matches,
                    total: total,
                    missing: missing,
                    matched: matched,
                    fullRecipe: recipe
                };

                if (compatibility === 100) {
                    results.perfect.push(analysis);
                } else if (compatibility >= 80) {
                    results.veryGood.push(analysis);
                } else if (compatibility >= 60) {
                    results.good.push(analysis);
                }
            });

            APP.allResults = results;
            return results;
        }

        // Display results
        // Search & Filter Functions
        function applySearchAndFilters(results) {
            let allRecipes = [
                ...results.perfect.map(r => ({...r, category: 'perfect'})),
                ...results.veryGood.map(r => ({...r, category: 'veryGood'})),
                ...results.good.map(r => ({...r, category: 'good'}))
            ];

            // Apply perfect matches filter
            if (APP.activeFilters.perfectMatches) {
                allRecipes = allRecipes.filter(r => r.missing.length === 0);
            }

            // Apply missing 1 ingredient filter
            if (APP.activeFilters.missingOne) {
                allRecipes = allRecipes.filter(r => r.missing.length === 1);
            }

            // Apply sorting
            allRecipes = sortRecipes(allRecipes);

            // Reorganize back into categories
            return {
                perfect: allRecipes.filter(r => r.category === 'perfect'),
                veryGood: allRecipes.filter(r => r.category === 'veryGood'),
                good: allRecipes.filter(r => r.category === 'good')
            };
        }

        function sortRecipes(recipes) {
            const sorted = [...recipes];
            switch (APP.sortBy) {
                case 'name-asc':
                    return sorted.sort((a, b) => a.name.localeCompare(b.name));
                case 'name-desc':
                    return sorted.sort((a, b) => b.name.localeCompare(a.name));
                case 'compatibility':
                default:
                    return sorted.sort((a, b) => b.compatibility - a.compatibility);
            }
        }

        function updateFilterUI() {
            // Show/hide filter controls
            if (APP.allResults) {
                elements.filterControls.style.display = 'block';
            }

            // Update active filters display
            const activeFiltersArray = [];
            if (APP.activeFilters.perfectMatches) {
                activeFiltersArray.push('Perfect Matches');
            }
            if (APP.activeFilters.missingOne) {
                activeFiltersArray.push('Missing 1 Ingredient');
            }

            if (activeFiltersArray.length > 0) {
                let html = '';
                activeFiltersArray.forEach(filter => {
                    html += '<span class="filter-tag">' + escapeHtml(filter) + '</span>';
                });
                elements.activeFiltersDiv.innerHTML = html;
                elements.activeFiltersDiv.style.display = 'flex';
            } else {
                elements.activeFiltersDiv.style.display = 'none';
            }

            // Update button active states
            elements.perfectMatchesBtn.classList.toggle('active', APP.activeFilters.perfectMatches);
            elements.almostThereBtn.classList.toggle('active', APP.activeFilters.missingOne);
        }

        function refreshResults() {
            if (!APP.allResults) return;

            const filteredResults = applySearchAndFilters(APP.allResults);
            displayResults(filteredResults);
            updateFilterUI();
        }

        function clearAllFilters() {
            APP.activeFilters.perfectMatches = false;
            APP.activeFilters.missingOne = false;
            APP.sortBy = 'compatibility';
            elements.sortSelect.value = 'compatibility';
            refreshResults();
        }

        function showRandomCocktail() {
            if (!APP.allResults) return;

            const allRecipes = [
                ...APP.allResults.perfect,
                ...APP.allResults.veryGood,
                ...APP.allResults.good
            ];

            if (allRecipes.length === 0) return;

            const random = allRecipes[Math.floor(Math.random() * allRecipes.length)];

            // Find category and index
            let category, index;
            if (APP.allResults.perfect.includes(random)) {
                category = 'perfect';
                index = APP.allResults.perfect.indexOf(random);
            } else if (APP.allResults.veryGood.includes(random)) {
                category = 'veryGood';
                index = APP.allResults.veryGood.indexOf(random);
            } else {
                category = 'good';
                index = APP.allResults.good.indexOf(random);
            }

            showRecipe(category, index);
        }

        // Recently Viewed Functions
        function addToRecentlyViewed(recipeName) {
            // Remove if already exists
            APP.recentlyViewed = APP.recentlyViewed.filter(item => item.name !== recipeName);

            // Add to beginning
            APP.recentlyViewed.unshift({
                name: recipeName,
                timestamp: new Date().getTime()
            });

            // Keep only last 6
            APP.recentlyViewed = APP.recentlyViewed.slice(0, 6);

            // Save to localStorage
            localStorage.setItem('cocktail_recentlyViewed', JSON.stringify(APP.recentlyViewed));

            displayRecentlyViewed();
        }

        function displayRecentlyViewed() {
            if (APP.recentlyViewed.length === 0) {
                elements.recentlyViewedSection.style.display = 'none';
                return;
            }

            elements.recentlyViewedSection.style.display = 'block';

            let html = '';
            APP.recentlyViewed.forEach(item => {
                const timeAgo = getTimeAgo(item.timestamp);
                html += '<div class="recently-viewed-item" onclick="openRecentRecipe(\'' + escapeHtml(item.name).replace(/'/g, "\\'") + '\')">';
                html += '<div class="recently-viewed-name">' + escapeHtml(item.name) + '</div>';
                html += '<div class="recently-viewed-time">' + timeAgo + '</div>';
                html += '</div>';
            });

            elements.recentlyViewedList.innerHTML = html;
        }

        function getTimeAgo(timestamp) {
            const seconds = Math.floor((new Date().getTime() - timestamp) / 1000);
            if (seconds < 60) return 'Just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + 'm ago';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'h ago';
            const days = Math.floor(hours / 24);
            return days + 'd ago';
        }

        function openRecentRecipe(recipeName) {
            if (!APP.allResults) return;

            // Find the recipe
            const categories = ['perfect', 'veryGood', 'good'];
            for (const cat of categories) {
                const index = APP.allResults[cat].findIndex(r => r.name === recipeName);
                if (index !== -1) {
                    showRecipe(cat, index);
                    return;
                }
            }
        }

        function displayResults(results) {
            const total = results.perfect.length + results.veryGood.length + results.good.length;

            let html = '<div class="stats">';
            html += '<div class="stat-card"><div class="stat-number">' + results.perfect.length + '</div><div class="stat-label">Perfect Matches</div></div>';
            html += '<div class="stat-card"><div class="stat-number">' + results.veryGood.length + '</div><div class="stat-label">Very Good</div></div>';
            html += '<div class="stat-card"><div class="stat-number">' + total + '</div><div class="stat-label">Total Makeable</div></div>';
            html += '</div>';

            if (results.perfect.length > 0) {
                html += '<div class="category"><div class="category-title perfect">üü¢ Perfect Matches (' + results.perfect.length + ')</div>';
                results.perfect.forEach(function(r, index) {
                    html += createRecipeCard(r, 'perfect', index);
                });
                html += '</div>';
            }

            if (results.veryGood.length > 0) {
                const displayCount = Math.min(results.veryGood.length, 20);
                html += '<div class="category"><div class="category-title very-good">üü° Very Good Matches (' + results.veryGood.length + ')</div>';
                results.veryGood.slice(0, displayCount).forEach(function(r, index) {
                    html += createRecipeCard(r, 'veryGood', index);
                });
                if (results.veryGood.length > displayCount) {
                    html += '<div class="info-message">Showing ' + displayCount + ' of ' + results.veryGood.length + ' recipes</div>';
                }
                html += '</div>';
            }

            if (results.good.length > 0) {
                const displayCount = Math.min(results.good.length, 10);
                html += '<div class="category"><div class="category-title good">üîµ Good Matches (' + results.good.length + ')</div>';
                results.good.slice(0, displayCount).forEach(function(r, index) {
                    html += createRecipeCard(r, 'good', index);
                });
                if (results.good.length > displayCount) {
                    html += '<div class="info-message">Showing ' + displayCount + ' of ' + results.good.length + ' recipes</div>';
                }
                html += '</div>';
            }

            if (total === 0) {
                html += '<div class="info-message">No matching recipes found. Try adding more ingredients to your bar stock!</div>';
            }

            elements.resultsDiv.innerHTML = html;

            // Update results count
            if (elements.resultsCount) {
                elements.resultsCount.textContent = 'Showing ' + total + ' recipe' + (total !== 1 ? 's' : '');
            }

            // Add click handlers
            document.querySelectorAll('.recipe-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    const category = this.dataset.category;
                    const index = parseInt(this.dataset.index);
                    showRecipe(category, index);
                });
            });
        }

        // Create recipe card HTML
        function createRecipeCard(recipe, category, index) {
            const missingText = recipe.missing.length === 0 ? 'You have everything!' :
                              recipe.missing.length <= 2 ? 'Missing: ' + recipe.missing.join(', ') :
                              'Missing: ' + recipe.missing.length + ' items';

            return '<div class="recipe-item" data-category="' + category + '" data-index="' + index + '">' +
                   '<div class="recipe-name">' + escapeHtml(recipe.name) + '</div>' +
                   '<div class="recipe-details">' + recipe.compatibility + '% - ' +
                   (recipe.missing.length > 0 ? '<span class="missing">' + escapeHtml(missingText) + '</span>' : missingText) +
                   '</div></div>';
        }

        // Show recipe modal
        function showRecipe(category, index) {
            const recipe = APP.allResults[category][index];
            if (!recipe) return;

            const isFavorite = APP.favorites.has(recipe.name);
            // Handle old data format (madeDates) and new format (hasMade)
            const history = APP.history[recipe.name] || { hasMade: false, rating: 0, notes: '' };
            const hasMade = history.hasMade || (history.madeDates && history.madeDates.length > 0) || false;

            let html = '<div style="display: flex; justify-content: space-between; align-items: start;">';
            html += '<div class="modal-title">' + escapeHtml(recipe.name) + '</div>';
            html += '<button id="favoriteBtn" class="favorite-btn' + (isFavorite ? ' active' : '') + '" data-recipe-name="' + escapeHtml(recipe.name) + '">';
            html += isFavorite ? '‚ù§Ô∏è' : 'ü§ç';
            html += '</button>';
            html += '</div>';

            html += '<div class="compatibility-badge">' + recipe.compatibility + '% Compatible</div>';

            // Action buttons
            html += '<div class="action-buttons">';
            const madeText = hasMade ? '‚úì Made This' : '‚úì Mark as Made';
            const madeStyle = hasMade ? 'background: var(--success);' : '';
            html += '<button id="madeThisBtn" class="action-btn" style="' + madeStyle + '" data-recipe-name="' + escapeHtml(recipe.name) + '">' + madeText + '</button>';
            html += '</div>';

            // Always show rating and notes section
            html += '<div class="made-this-section">';

            // Rating
            html += '<div style="margin-top: 10px;"><strong>Your Rating:</strong></div>';
            html += '<div id="ratingStars" class="rating-stars" data-recipe-name="' + escapeHtml(recipe.name) + '">';
            for (let i = 1; i <= 5; i++) {
                html += '<span class="' + (i <= history.rating ? 'filled' : '') + '" data-rating="' + i + '">‚òÖ</span>';
            }
            html += '</div>';

            // Notes
            html += '<div style="margin-top: 10px;"><strong>Your Notes:</strong></div>';
            html += '<textarea class="notes-input" id="recipeNotes" placeholder="Add your notes...">' + escapeHtml(history.notes || '') + '</textarea>';
            html += '<button id="saveNotesBtn" class="action-btn" style="margin-top: 10px;" data-recipe-name="' + escapeHtml(recipe.name) + '">Save Notes</button>';
            html += '</div>';

            html += '<div class="modal-section"><div class="modal-section-title">üìã Ingredients</div>';
            html += '<div class="modal-section-content"><ul class="ingredient-list">';

            recipe.fullRecipe.Ingredients.split('\n').forEach(function(line) {
                const trimmedLine = line.trim();
                if (trimmedLine) {
                    const hasIt = recipe.matched.some(m => m === trimmedLine);
                    const className = hasIt ? 'have' : 'missing';
                    html += '<li class="' + className + '">' + escapeHtml(trimmedLine) + '</li>';
                }
            });

            html += '</ul></div></div>';

            if (recipe.fullRecipe.Instructions) {
                html += '<div class="modal-section"><div class="modal-section-title">üî® Instructions</div>';
                html += '<div class="modal-section-content">' + escapeHtml(recipe.fullRecipe.Instructions) + '</div></div>';
            }

            if (recipe.fullRecipe.Glass) {
                html += '<div class="modal-section"><div class="modal-section-title">ü•É Glass</div>';
                html += '<div class="modal-section-content">' + escapeHtml(recipe.fullRecipe.Glass) + '</div></div>';
            }

            elements.modalBody.innerHTML = html;
            elements.modal.classList.add('active');

            // Add to recently viewed
            addToRecentlyViewed(recipe.name);

            // Add event listeners after HTML is inserted
            const favoriteBtn = document.getElementById('favoriteBtn');
            if (favoriteBtn) {
                favoriteBtn.addEventListener('click', function() {
                    const recipeName = this.getAttribute('data-recipe-name');
                    toggleFavorite(recipeName);
                });
            }

            const madeThisBtn = document.getElementById('madeThisBtn');
            if (madeThisBtn) {
                madeThisBtn.addEventListener('click', function() {
                    const recipeName = this.getAttribute('data-recipe-name');
                    markAsMade(recipeName);
                });
            }

            const ratingStars = document.getElementById('ratingStars');
            if (ratingStars) {
                const recipeName = ratingStars.getAttribute('data-recipe-name');
                const stars = ratingStars.querySelectorAll('span');
                stars.forEach(function(star) {
                    star.addEventListener('click', function() {
                        const rating = parseInt(this.getAttribute('data-rating'));
                        setRating(recipeName, rating);
                    });
                });
            }

            const saveNotesBtn = document.getElementById('saveNotesBtn');
            if (saveNotesBtn) {
                saveNotesBtn.addEventListener('click', function() {
                    const recipeName = this.getAttribute('data-recipe-name');
                    const notes = document.getElementById('recipeNotes').value;
                    saveNotes(recipeName, notes);
                });
            }
        }

        // Close modal
        function closeModal() {
            elements.modal.classList.remove('active');
        }

        // Handle modal background click
        function handleModalClick(e) {
            if (e.target === elements.modal) {
                closeModal();
            }
        }

        // Generate shopping list
        function generateShoppingList(results) {
            const missing = {};

            results.veryGood.concat(results.good).forEach(function(recipe) {
                recipe.missing.forEach(function(ingredient) {
                    const cleaned = normalizeIngredient(ingredient);

                    if (cleaned && !cleaned.includes('ice') && !cleaned.includes('garnish')) {
                        if (!missing[cleaned]) {
                            missing[cleaned] = { count: 0, recipes: [] };
                        }
                        missing[cleaned].count++;
                        if (!missing[cleaned].recipes.includes(recipe.name)) {
                            missing[cleaned].recipes.push(recipe.name);
                        }
                    }
                });
            });

            const sorted = Object.keys(missing)
                .map(key => [key, missing[key]])
                .sort((a, b) => b[1].recipes.length - a[1].recipes.length);

            if (sorted.length === 0) {
                elements.shoppingList.style.display = 'none';
                return;
            }

            let html = '<div class="shopping-list-title">üõí Smart Shopping List</div>';
            html += '<div style="margin-bottom: 20px; opacity: 0.95;">Top ingredients to unlock more recipes:</div>';

            sorted.slice(0, 15).forEach(function(item) {
                html += '<div class="shopping-item">';
                html += '<div class="shopping-item-name">' + escapeHtml(item[0].charAt(0).toUpperCase() + item[0].slice(1)) + '</div>';
                html += '<div class="shopping-item-impact">+' + item[1].recipes.length + ' recipe' + (item[1].recipes.length > 1 ? 's' : '') + '</div>';
                html += '</div>';
            });

            elements.shoppingList.innerHTML = html;
            elements.shoppingList.style.display = 'block';
        }

        // Setup search functionality
        function setupSearch() {
            const ingredients = [];
            APP.currentInventory.forEach(function(val, key) {
                if (!['ice', 'crushed ice', 'ice cubes', 'water', 'salt'].includes(key)) {
                    ingredients.push(key);
                }
            });
            ingredients.sort();

            elements.ingredientSelect.innerHTML = '<option value="">-- Select an ingredient --</option>';
            ingredients.forEach(function(ing) {
                const option = document.createElement('option');
                option.value = ing;
                option.textContent = ing.charAt(0).toUpperCase() + ing.slice(1);
                elements.ingredientSelect.appendChild(option);
            });
        }

        // Handle ingredient search
        function handleSearch() {
            const selected = elements.ingredientSelect.value;
            if (!selected) return;

            const allRecipes = APP.allResults.perfect.concat(APP.allResults.veryGood, APP.allResults.good);
            const matches = [];

            allRecipes.forEach(function(recipe) {
                // Split ingredients into lines and check each one with fuzzy matching
                const ingredientLines = recipe.fullRecipe.Ingredients.split('\n');
                let foundMatch = false;

                for (let line of ingredientLines) {
                    const normalized = normalizeIngredient(line);
                    const selectedNorm = normalizeIngredient(selected);

                    // Check with fuzzy matching
                    if (normalized.includes(selectedNorm) ||
                        selectedNorm.includes(normalized) ||
                        areSimilarIngredients(normalized, selectedNorm, 0.85)) {
                        foundMatch = true;
                        break;
                    }
                }

                if (foundMatch) {
                    matches.push(recipe);
                }
            });

            if (matches.length === 0) {
                elements.searchResponse.innerHTML = '<div style="padding: 20px;">No cocktails found with <strong>' + escapeHtml(selected) + '</strong></div>';
            } else {
                let html = '<div style="font-weight: bold; margin-bottom: 15px;">Found ' + matches.length + ' cocktail' + (matches.length > 1 ? 's' : '') + ' with <strong>' + escapeHtml(selected) + '</strong>:</div>';

                matches.slice(0, 15).forEach(function(recipe) {
                    const category = APP.allResults.perfect.includes(recipe) ? 'perfect' :
                                   APP.allResults.veryGood.includes(recipe) ? 'veryGood' : 'good';
                    const index = APP.allResults[category].indexOf(recipe);

                    html += createRecipeCard(recipe, category, index);
                });

                if (matches.length > 15) {
                    html += '<div style="margin-top: 10px; font-style: italic;">Showing first 15 results</div>';
                }

                elements.searchResponse.innerHTML = html;

                // Add click handlers
                elements.searchResponse.querySelectorAll('.recipe-item').forEach(function(item) {
                    item.addEventListener('click', function() {
                        const category = this.dataset.category;
                        const index = parseInt(this.dataset.index);
                        showRecipe(category, index);
                    });
                });
            }

            elements.searchResponse.classList.add('active');
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Make functions globally accessible for onclick handlers
        window.toggleFavorite = toggleFavorite;
        window.markAsMade = markAsMade;
        window.setRating = setRating;
        window.saveNotes = saveNotes;
        window.addIngredient = addIngredient;
        window.removeIngredient = removeIngredient;
        window.exportInventory = exportInventory;
        window.showRecipe = showRecipe;
        window.closeModal = closeModal;

        // Initialize app
        init();
    </script>
</body>
</html>
